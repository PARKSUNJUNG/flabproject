<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>굿즈 등록</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/global.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/product/register.css}">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="container my-5">

<h2 class="mb-4 fw-bold">굿즈 등록</h2>

<form th:action="@{/admin/product/register}" method="post" enctype="multipart/form-data" th:object="${request}">

    <!-- 1. 기본 정보 -->
    <div class="section-title">기본 정보</div>
    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">상품명</label>
            <input type="text" class="form-control" name="productName" required>
        </div>

        <div class="mb-3">
            <label class="form-label">카테고리</label>
            <select class="form-select" name="categoryId" required>
                <option value="">카테고리 선택</option>
                <option th:each="category : ${categories}"
                        th:value="${category.id}"
                        th:text="${category.name}"></option>
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">대표 썸네일</label>
            <div class="d-flex align-items-center gap-2">
                <input type="file" class="form-control" name="thumbnail" accept="image/*" required onchange="previewThumbnail(this)">
                <img id="preview" class="img-thumbnail" style="display:none; width:150px;">
            </div>
        </div>

        <div class="col-md-12">
            <label class="form-label">요약 설명</label>
            <textarea class="form-control" name="summary" rows="2"></textarea>
        </div>

        <div class="col-md-4">
            <label class="form-label">가격</label>
            <input type="number" class="form-control" name="price">
        </div>

        <div class="col-md-4">
            <label class="form-label">재고</label>
            <input type="number" class="form-control" name="stock" id="stockInput" th:field="*{stock}">
        </div>

        <div class="col-md-4">
            <label class="form-label">옵션 사용 여부</label>
            <select class="form-select" name="useOption" id="useOption">
                <option value="false" selected>사용 안함</option>
                <option value="true">사용함</option>
            </select>
        </div>
    </div>

    <!-- 2. 옵션 조합 재고 (수동 입력) -->
    <div id="optionStockArea" style="display:none;" class="mt-4">
        <div class="section-title">옵션 조합 재고</div>
        <div id="optionStockWrapper"></div>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="addOptionStockBtn">옵션 조합 추가</button>
    </div>

    <!-- 3. 상세 콘텐츠 -->
    <div class="section-title mt-4">상품 상세 콘텐츠</div>
    <div id="contentsWrapper"></div>
    <button type="button" class="btn btn-outline-dark btn-sm" id="addContentBtn">콘텐츠 추가</button>

    <!-- 4. 판매 기간 -->
    <div class="section-title mt-4">판매 기간</div>
    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">판매 시작</label>
            <input type="text" id="saleStart" name="saleStart" class="form-control" placeholder="판매 시작">
        </div>
        <div class="col-md-6">
            <label class="form-label">판매 종료</label>
            <input type="text" id="saleEnd" name="saleEnd" class="form-control" placeholder="판매 종료">
        </div>
    </div>

    <!-- 5. 저장 버튼 -->
    <div class="mt-5 text-end">
        <button type="submit" class="btn btn-primary btn-lg">저장</button>
    </div>

</form>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    // 판매 기간
    flatpickr("#saleStart", {
        enableTime: true,
        dateFormat: "Y년 m월 d일 H:i",
        defaultDate: "today",
    });

    flatpickr("#saleEnd", {
        enableTime: true,
        dateFormat: "Y년 m월 d일 H:i",
        defaultDate: new Date().fp_incr(1) // 내일
    });

    // 썸네일 미리보기
    function previewThumbnail(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = document.getElementById('preview');
            img.src = e.target.result;
            img.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // 옵션이 있으면 재고 Input 비활성화
    function toggleStockByOption() {
        const useOption = document.getElementById('useOption').value === 'true';
        const stockInput = document.getElementById('stockInput');

        if (useOption) {
            stockInput.value = 0;
            stockInput.disabled = true;
            stockInput.closest('.col-md-4').style.display = 'none';
        } else {
            stockInput.disabled = false;
            stockInput.closest('.col-md-4').style.display = 'block';
        }
    }

    document.getElementById('useOption').addEventListener('change', toggleStockByOption);

    // 페이지 로드 시 초기 상태 반영
    window.addEventListener('DOMContentLoaded', toggleStockByOption);

    // 옵션 조합 재고
    const useOption = document.getElementById('useOption');
    const optionStockArea = document.getElementById('optionStockArea');
    const optionStockWrapper = document.getElementById('optionStockWrapper');
    const addOptionStockBtn = document.getElementById('addOptionStockBtn');

    useOption.addEventListener('change', () => {
        if (useOption.value === 'true') {
            optionStockArea.style.display = 'block';
        } else {
            optionStockArea.style.display = 'none';
            optionStockWrapper.innerHTML = '';
        }
    });

    let optionIndex = 0;

    addOptionStockBtn.addEventListener('click', () => {
        const row = document.createElement('div');
        row.classList.add('row', 'g-3', 'align-items-end', 'mb-2');
        row.innerHTML = `
            <div class="col-md-6">
                <label class="form-label">옵션 조합</label>
                <input type="text"
                       class="form-control"
                       name="optionStocks[${optionIndex}].optCombination"
                       placeholder="예: 빨강 / M">
            </div>
            <div class="col-md-4">
                <label class="form-label">재고</label>
                <input type="number"
                       class="form-control"
                       name="optionStocks[${optionIndex}].stock">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger btn-sm remove-btn">삭제</button>
            </div>
        `;
        row.querySelector('.remove-btn').addEventListener('click', () => row.remove());
        optionStockWrapper.appendChild(row);
        optionIndex++;
    });

    // 상품 상세 콘텐츠 (text / image / html)
    const contentsWrapper = document.getElementById('contentsWrapper');
    const addContentBtn = document.getElementById('addContentBtn');
    let contentIndex = 0;

    addContentBtn.addEventListener('click', () => {
        const currentIndex = contentIndex;
        const box = document.createElement('div');
        box.classList.add('content-box', 'mb-3', 'border', 'p-2');

        box.innerHTML = `
            <div class="row g-3 align-items-start">
                <!-- 왼쪽: 타입 선택 -->
                <div class="col-md-2">
                    <label class="form-label">타입</label>
                    <select class="form-select content-type" name="productContents[${currentIndex}].type">
                        <option value="text">텍스트</option>
                        <option value="image">이미지</option>
                        <option value="html">HTML</option>
                    </select>
                </div>

                <!-- 오른쪽: 입력란 -->
                <div class="col-md-10">
                    <label class="form-label d-none d-md-block">&nbsp;</label>
                    <div class="input-wrapper">
                        <textarea class="form-control content-input"
                                  rows="2"
                                  name="productContents[${currentIndex}].contents"
                                  placeholder="텍스트 입력"></textarea>
                    </div>
                </div>
            </div>
            <div class="text-end mt-2">
                <button type="button" class="btn btn-danger btn-sm remove-btn">삭제</button>
            </div>
        `;

        // 타입에 따라 입력란 변경
        const typeSelect = box.querySelector('.content-type');
        const inputWrapper = box.querySelector('.input-wrapper');

        typeSelect.addEventListener('change', () => {
            inputWrapper.innerHTML = '';

            if (typeSelect.value === 'text') {
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control content-input';
                textarea.rows = 2;
                textarea.placeholder = '텍스트 입력';
                textarea.name = `productContents[${currentIndex}].contents`;
                inputWrapper.appendChild(textarea);

            } else if (typeSelect.value === 'image') {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.className = 'form-control content-input';
                fileInput.accept = 'image/*';
                fileInput.name = `productContents[${currentIndex}].file`;

                const imgPreview = document.createElement('img');
                imgPreview.className = 'img-thumbnail mt-2';
                imgPreview.style.display = 'none';
                imgPreview.style.width = '150px';

                fileInput.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = ev => {
                        imgPreview.src = ev.target.result;
                        imgPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                });

                inputWrapper.appendChild(fileInput);
                inputWrapper.appendChild(imgPreview);

            } else if (typeSelect.value === 'html') {
                const textarea = document.createElement('textarea');
                textarea.className = 'form-control content-input';
                textarea.rows = 5;
                textarea.placeholder = 'HTML 코드 입력';
                textarea.name = `productContents[${currentIndex}].contents`;
                inputWrapper.appendChild(textarea);
            }
        });

        // 삭제 버튼
        box.querySelector('.remove-btn').addEventListener('click', () => box.remove());

        contentsWrapper.appendChild(box);
        contentIndex++;
    });
</script>

</body>
</html>
