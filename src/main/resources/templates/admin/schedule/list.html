<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Schedule 관리</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin/global_admin.css}" />
    <link rel="stylesheet" th:href="@{/css/admin/schedule/list.css}" />
</head>
<body class="bg-light">

<div class="admin-layout">
    <th:block th:replace="admin/fragments/sidebar :: adminSidebar('schedule')"/>

    <main class="admin-content d-flex flex-column">
        <div class="container mt-5 flex-grow-1">
            <h2 class="mb-4 fw-bold">Schedule</h2>

            <div class="row g-3">
                <!-- 달력 -->
                <div class="col-lg-8">
                    <!-- 헤더 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <a class="btn btn-outline-secondary"
                           th:href="@{/admin/schedules(year=${year}, month=${month-1})}">
                            ◀
                        </a>

                        <h4 class="mb-0" th:text="${year} + '년 ' + ${month} + '월'"></h4>

                        <a class="btn btn-outline-secondary"
                           th:href="@{/admin/schedules(year=${year}, month=${month+1})}">
                            ▶
                        </a>
                    </div>

                    <div class="calendar-grid mb-2 text-center fw-bold">
                        <div>일</div>
                        <div>월</div>
                        <div>화</div>
                        <div>수</div>
                        <div>목</div>
                        <div>금</div>
                        <div>토</div>
                    </div>

                    <div id="calendar" class="calendar-grid"></div>
                </div>

                <!-- 일자 상세 -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 id="selected-date" class="card-title"></h5>

                            <div id="schedule-list"></div>

                            <a th:href="@{/admin/schedules/register}"
                               id="add-btn"
                               class="btn btn-primary w-100 mt-3">
                                + 일정 추가
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const message = /*[[${message}]]*/ null;

    if (message) {
        alert(message);
    }
    /*]]>*/

    // 일정 추가 버튼을 누를때 해당 날짜도 넘긴다
    document.addEventListener('DOMContentLoaded', () => {
        const addBtn = document.getElementById('add-btn');

        if (addBtn) {
        addBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const date = selectedDate ?? today;
                location.href = `/admin/schedules/register?date=${date}`;
            });
        }
    });

    // 달력 렌더링
    const year = [[${year}]];
    const month = [[${month}]];
    const today = /*[[${today}]]*/ null;
    let selectedDate = today;

    fetch(`/admin/api/schedules?year=${year}&month=${month}`)
        .then(res => res.json())
        .then(data => {
            renderCalendar(data);

            if (today) {
                loadDayDetail(today);
            }
        });

    const colorMap = {};

    function getColor(key) {
        if (!colorMap[key]) {
            colorMap[key] = `hsl(${Math.random() * 360}, 70%, 85%)`;
        }
        return colorMap[key];
    }

    function renderCalendar(data) {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        const scheduleMap = {};
        data.days.forEach(d => {
            scheduleMap[d.date] = d;
        });

        const firstDate = new Date(data.year, data.month - 1, 1);
        const lastDate = new Date(data.year, data.month, 0);

        const firstDayOfWeek = firstDate.getDay(); // 요일을 숫자로 반환
        const lastDay = lastDate.getDate();

        /*  1. 앞쪽 빈칸 채우기 */
        for (let i = 0; i < firstDayOfWeek; i++) {
            calendar.appendChild(document.createElement('div'));
        }

        /*  2. 날짜 칸 생성 */
        for (let day = 1; day <= lastDay; day++) {
            const dateStr =
                `${data.year}-${String(data.month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.dataset.date = dateStr;

            if (dateStr === today) {
                div.classList.add('today');
            }

            if (dateStr === selectedDate) {
                div.classList.add('selected');
            }

            const scheduleDay = scheduleMap[dateStr];

            div.innerHTML = `
                <div class="calendar-day-header">${day}</div>
                <div>
                    ${
                      scheduleDay
                        ? scheduleDay.targets.map(t =>
                            `<span class="target-badge"
                                   style="background:${getColor(t.key)}">
                                ${t.label}
                             </span>`
                          ).join('')
                        : ''
                    }
                </div>
            `;

            div.onclick = () => selectDate(dateStr);
            calendar.appendChild(div);
        }
    }

    function selectDate(dateStr){
        selectedDate = dateStr;

        // 기존 선택 해제
        document.querySelectorAll('.calendar-day.selected')
            .forEach(el => el.classList.remove('selected'));

        // 새 선택
        const target = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
        if (target) {
            target.classList.add('selected');
        }

        loadDayDetail(dateStr);
    }

    function loadDayDetail(date){
        fetch(`/admin/api/schedules/day?date=${date}`)
            .then(res=>res.json())
            .then(renderDayDetail);
    }

    function renderDayDetail(data){
        document.getElementById('selected-date').innerText = data.date;

        const container = document.getElementById('schedule-list');
        container.innerHTML = '';

        if(!data.schedules || data.schedules.length === 0){
            container.innerHTML = '<p class="text-muted">일정 없음</p>';
            return;
        }

        data.schedules.forEach(s => {
            container.innerHTML += `
                <div class="p-2 schedule-summary d-flex justify-content-between align-items-center"
                     style="cursor:pointer"
                     onclick="toggleDetail(this)">
                    <div>
                        <div class="fw-bold">${s.targets}</div>
                        <div class="text-muted small">
                            ${s.startTime} ~ ${s.endTime}
                        </div>
                        <div>${s.content}</div>
                    </div>

                    <!-- 화살표 -->
                    <div class="ms-2 text-muted toggle-icon">▼</div>
                </div>

                <div class="p-2 border-top bg-light schedule-detail"
                     style="display:none;">
                    <div class="mb-1">
                        <strong>장소</strong> : ${s.place ?? '-'}
                    </div>
                    <div class="mb-2">
                        <strong>메모</strong> : ${s.memo ?? '-'}
                    </div>

                    <!-- 버튼 영역 -->
                    <div class="d-flex justify-content-end gap-2">
                        <a href="/admin/schedules/${s.scheduleId}/edit"
                           class="btn btn-sm btn-outline-primary">
                            수정
                        </a>

                        <button class="btn btn-sm btn-outline-danger"
                                onclick="deleteSchedule(${s.scheduleId})">
                            삭제
                        </button>
                    </div>
                </div>
            `;
        });
    }

    function toggleDetail(el) {
        const detail = el.nextElementSibling;
        detail.style.display =
            detail.style.display === 'none' ? 'block' : 'none';
    }
</script>

</body>
</html>