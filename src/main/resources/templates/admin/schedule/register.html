<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Schedule Register</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/admin/global_admin.css}" />
</head>
<body class="container py-4">
<div class="admin-layout">
    <th:block th:replace="admin/fragments/sidebar :: adminSidebar('scheduleRegister')"/>

    <main class="admin-content d-flex flex-column">
        <div class="container mt-5 flex-grow-1">
            <h2 class="mb-4 fw-bold">Schedule Register</h2>

            <form th:action="@{/admin/schedules/register}" method="post">

                <div class="mb-3">
                    <label class="form-label">대상</label>

                    <select class="form-select" name="targetTypeSelect" id="targetTypeSelect">
                        <option value="">선택</option>
                        <option value="GROUP">단체</option>
                        <option value="MEMBER">개인</option>
                    </select>
                </div>

                <div id="groupTarget" style="display:none;">
                    <input type="hidden" name="targets[0].type" value="GROUP"/>
                    <input type="hidden" name="targets[0].groupCode" value="Allday Project"/>

                    <div class="alert alert-info">
                        ADP
                    </div>
                </div>

                <div id="memberTarget" style="display:none;">
                    <div id="memberTargetList"></div>
                </div>

                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">시작 일시</label>
                        <input type="datetime-local" class="form-control" name="startDateTime">
                    </div>
                    <div class="col">
                        <label class="form-label">종료 일시</label>
                        <input type="datetime-local" class="form-control" name="endDateTime">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">장소</label>
                    <input type="text" class="form-control" name="place">
                </div>

                <div class="mb-3">
                    <label class="form-label">내용</label>
                    <input type="text" class="form-control" name="content">
                </div>

                <div class="mb-3">
                    <label class="form-label">메모</label>
                    <textarea class="form-control" name="memo" rows="3"></textarea>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">등록</button>
                    <a th:href="@{/admin/schedules}" class="btn btn-secondary">취소</a>
                </div>

            </form>
        </div>
    </main>

</div>

<script th:inline="javascript">
    const select = document.getElementById("targetTypeSelect");
    const group = document.getElementById("groupTarget");
    const member = document.getElementById("memberTarget");
    const memberTargetList = document.getElementById("memberTargetList");

    // ===== MEMBER 타겟 조합 추가 =====
    let targetIndex = 0;

    // 타임리프 -> js 데이터 전달
    const members = /*[[${members}]]*/ [];

    select.addEventListener("change", function () {
        group.style.display = "none";
        member.style.display = "none";

        // 초기화
        memberTargetList.innerHTML = "";
        targetIndex = 0;

        if (this.value === "GROUP") {
            memberTargetList.innerHTML = "";
            group.style.display = "block";
        }

        if (this.value === "MEMBER") {
            group.innerHTML = "";
            member.style.display = "block";
            addMemberTarget(); // 자동 생성
        }
    });

    function addMemberTarget() {
        let html = `
        <div class="border rounded p-3 mb-2">
            <input type="hidden" name="targets[${targetIndex}].type" value="MEMBER"/>

            <div class="fw-bold mb-2">멤버 조합</div>

            <div class="d-flex flex-wrap gap-3">
        `;

        members.forEach(m => {
            html += `
            <div class="form-check">
                <input class="form-check-input"
                        type="checkbox"
                        name="targets[${targetIndex}].memberIds"
                        value="${m.id}">
                <label class="form-check-label">${m.name}</label>
            </div>
            `;

        });

        html += `
            </div>
        </div>
        `;

        memberTargetList.insertAdjacentHTML("beforeend", html);
        targetIndex++;
    }
</script>

</body>
</html>