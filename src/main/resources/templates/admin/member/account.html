<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Member 등록</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin/global_admin.css}" />
</head>
<body>
<div class="admin-layout">
    <th:block th:replace="admin/fragments/sidebar :: adminSidebar('memberAccount')"/>

    <main class="admin-content d-flex flex-column">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-7">
                <div class="container mt-5 flex-grow-1">
                    <form id="registerForm">
                        <h2 class="mb-4 fw-bold">Member Register</h2>

                        <div class="mb-3">
                            <label class="form-label">이메일</label>
                            <div class="d-flex gap-2">
                                <input type="email" id="email" class="form-control" required>
                                <button type="button"
                                        id="checkEmailBtn"
                                        class="btn btn-outline-secondary flex-shrink-0 px-3rmsep ">
                                    중복 체크
                                </button>
                            </div>
                            <small id="emailCheckMsg" class="text-danger"></small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">비밀번호</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">이름</label>
                            <input type="text" id="name" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">상태</label>
                            <select id="active" class="form-select" required>
                                <option value="" selected disabled hidden>선택</option>
                                <option value="true">사용중</option>
                                <option value="false">사용중지</option>
                            </select>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">등록</button>
                            <a th:href="@{/admin/schedules}" class="btn btn-secondary">취소</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

</div>

<script type="module">
    const form = document.getElementById("registerForm");
    const emailInput = document.getElementById("email");
    const checkEmailBtn = document.getElementById("checkEmailBtn");
    const emailCheckMsg = document.getElementById("emailCheckMsg");

    let isEmailChecked = false; // 이메일 중복 체크 여부

    // 이메일 중복 체크 버튼 클릭 이벤트
    checkEmailBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        if (!email) {
            alert("이메일을 입력해주세요.");
            return;
        }

        const res = await fetch(`/admin/member/checkemail?email=${encodeURIComponent(email)}`);
        const data = await res.json();

        if (data.exists) {
            emailCheckMsg.textContent = data.message;
            isEmailChecked = false;
        } else {
            emailCheckMsg.textContent = "사용 가능한 이메일입니다.";
            emailCheckMsg.style.color = "green";
            isEmailChecked = true;
        }
    });

    // 회원가입 제출 이벤트
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 이메일 중복 체크 확인
        if (!isEmailChecked) {
            alert("이메일 중복 체크를 해주세요.");
            return;
        }

        const data = {
            email: emailInput.value,
            password: document.getElementById("password").value,
            name: document.getElementById("name").value,
            active: document.getElementById("active").value,
        };

        const res = await fetch("/admin/member/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
        });

        if (res.ok) {
            alert("연예인 회원 등록 완료");
            window.location.href = "/admin/schedules";
        } else {
            const err = await res.text();
            alert("회원가입 실패: " + err);
        }
    });
</script>
</body>
</html>