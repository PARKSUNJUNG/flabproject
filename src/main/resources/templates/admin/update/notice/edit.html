<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Notice Edit</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin/global_admin.css}" />
    <link rel="stylesheet"
          href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
</head>
<body>
<div class="admin-layout">
    <th:block th:replace="admin/fragments/sidebar :: adminSidebar('notice')"/>

    <main class="admin-content">
        <div class="container mt-5">

            <h2 class="mb-4 fw-bold">Notice Edit</h2>

            <form th:action="@{/admin/update/notices/{id}/edit(id=${notice.id})}"
                  th:object="${notice}"
                  method="post"
                  enctype="multipart/form-data"
                  class="card p-4 shadow-sm">

                <div class="mb-3">
                    <label class="form-label fw-semibold">제목</label>
                    <input type="text" class="form-control"
                           th:field="*{title}"/>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">카테고리</label>
                    <select class="form-select" th:field="*{category}">
                        <option value="">선택</option>
                        <option th:each="cat : ${categories}"
                                th:value="${cat}"
                                th:text="${cat}">
                        </option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">내용</label>
                    <div id="editor"></div>
                    <input type="hidden" th:field="*{content}" id="content">
                </div>

                <div class="mb-3" th:if="${!#lists.isEmpty(notice.files)}">
                    <label class="form-label fw-semibold">기존 첨부파일</label>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center"
                            th:each="file : ${notice.files}">
                            <span th:text="${file.originalName}"></span>

                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    th:onclick="|deleteFile(${file.id}, this)|">
                                삭제
                            </button>
                        </li>
                    </ul>
                </div>

                <input type="hidden" name="deleteFileIds" id="deleteFileIds">

                <!-- 새 첨부파일 -->
                <div class="mb-3">
                    <input type="file" class="form-control" name="files" multiple/>
                </div>

                <div class="d-flex justify-content-end gap-2">
                    <a th:href="@{/admin/update/notices/list}"
                       class="btn btn-outline-secondary">
                        취소
                    </a>
                    <button type="submit"
                            class="btn btn-primary">
                        수정
                    </button>
                </div>
            </form>

        </div>
    </main>
</div>

<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<script th:inline="javascript">
    const editor = new toastui.Editor({
        el: document.querySelector('#editor'),
        height: '400px',
        initialEditType: 'wysiwyg',
        previewStyle: 'vertical',
        initialValue: /*[[${notice.content}]]*/ "",

        hooks: {
            addImageBlobHook: (blob, callback) => {
                const formData = new FormData();
                formData.append('image', blob);

                fetch('/admin/update/notices/image', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    callback(data.url, data.alt);
                })
                .catch(err => {
                    console.error(err);
                });
            }
        }
    });

    // submit 시 content 채우기
    document.querySelector('form').addEventListener('submit', function () {
        document.getElementById('content').value = editor.getHTML();
    });

    // 첨부파일 삭제
    const deleteFileIds = [];
    function deleteFile(fileId, btn){
        deleteFileIds.push(fileId);

        document.getElementById('deleteFileIds').value = deleteFileIds.join(',');

        const li = btn.closest('li');
        li.remove();
    }
</script>
</body>
</html>
