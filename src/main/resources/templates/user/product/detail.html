<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${product.productName}">굿즈 상세</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/user/global.css}" />
    <link rel="stylesheet" th:href="@{/css/user/product/detail.css}" />
</head>

<body>
<div th:replace="user/fragments/header :: header"></div>

<main>
    <div class="container my-5">
        <div class="row">
            <!-- 썸네일 -->
            <div class="col-md-6">
                <img th:src="${product.thumbnail}"
                     alt="굿즈 썸네일"
                     class="product-thumbnail">
            </div>

            <!-- 상품 정보 -->
            <div class="col-md-6">
                <h2 th:text="${product.productName}">상품명</h2>
                <p class="text-muted" th:text="${product.summary}">상품 요약</p>

                <!-- 품절 -->
                <div th:if="${product.stockStatus == T(space.product.StockStatus).OUT_OF_STOCK}"
                     class="out-of-stock mb-3">
                    품절된 상품입니다.
                </div>

                <!-- 옵션 사용 -->
                <div th:if="${product.useOption}">
                    <div class="mb-3">
                        <label class="form-label">옵션 선택</label>
                        <select class="form-select" id="optionSelect">
                            <option value="">옵션을 선택하세요</option>
                            <option th:each="opt : ${product.options}"
                                    th:value="${opt.optionId}"
                                    th:data-stock="${opt.stock}"
                                    th:data-name="${opt.optionCombination}"
                                    th:disabled="${opt.stockStatus == T(space.product.StockStatus).OUT_OF_STOCK}"
                                    th:text="${opt.optionCombination
                                        + (opt.stockStatus == T(space.product.StockStatus).OUT_OF_STOCK ? ' (품절)' : '')}">
                            </option>
                        </select>

                        <div id="selectedOptions" class="mt-3"></div>
                    </div>
                </div>

                <!-- 옵션 미사용 -->
                <div th:if="${!product.useOption}">
                    <div class="mb-3">
                        <label class="form-label">수량</label>
                        <input type="number"
                               id="quantity"
                               class="form-control"
                               min="1"
                               th:max="${product.stock}"
                               value="1">
                    </div>
                </div>

                <!-- 구매 영역 -->
                <div th:if="${product.stockStatus == T(space.product.StockStatus).IN_STOCK}">
                    <div class="price mb-3 text-end">
                        <span id="totalPrice" th:text="${product.basePrice}">0</span> 원
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary w-50">
                            장바구니
                        </button>
                        <button class="btn btn-primary w-50" id="orderBtn">
                            구매하기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <hr class="mt-5">

        <!-- 상품 상세 -->
        <div>
            <h4 class="mt-4 mb-4">상품 상세 정보</h4>

            <div th:each="content : ${product.productContents}">
                <!-- 이미지 -->
                <div th:if="${content.type == 'image'}" class="mb-4">
                    <img th:src="${content.contents}" class="img-fluid">
                </div>

                <!-- 텍스트 -->
                <div th:if="${content.type == 'text'}" class="mb-4">
                    <p th:utext="${content.contents}"></p>
                </div>

                <!-- html -->
                <div th:if="${content.type == 'html'}" class="mb-4"
                     th:utext="${content.contents}">
                </div>
            </div>
        </div>
    </div>

    <!-- 스크롤 탑 -->
    <button id="scrollTopBtn"
            class="btn btn-secondary"
            onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
        ↑ 위로
    </button>
</main>

<script>
    const basePrice = [[${product.basePrice}]];

    const optionSelect = document.getElementById("optionSelect");
    const selectedOptionsEl = document.getElementById("selectedOptions");
    const totalPriceEl = document.getElementById("totalPrice");

    const selectedOptions = new Map();

    function updateTotalPrice() {

        // 옵션 상품
        if([[${product.useOption}]]) {
            let total = 0;
            selectedOptions.forEach(opt => {
                total += basePrice * opt.qty;
            });
            totalPriceEl.innerText = total.toLocaleString();
            return;
        }

        // 옵션 미사용 상품
        const quantityInput = document.getElementById("quantity");
        const qty = Number(quantityInput.value);
        const total = basePrice * qty;
        totalPriceEl.innerText = total.toLocaleString();
    }

    optionSelect?.addEventListener("change", () => {
        const optionId = optionSelect.value;
        if (!optionId || selectedOptions.has(optionId)) return;

        const selected = optionSelect.selectedOptions[0];
        const optionName = selected.dataset.name;
        const maxStock = Number(selected.dataset.stock);

        selectedOptions.set(optionId, { qty: 1 });

        const optionDiv = document.createElement("div");
        optionDiv.className =
            "d-flex align-items-center justify-content-between border p-2 mb-2";
        optionDiv.dataset.optionId = optionId;

        optionDiv.innerHTML = `
            <div>
                <strong>${optionName}</strong>
            </div>
            <div class="d-flex align-items-center gap-2">
                <input type="number"
                       min="1"
                       max="${maxStock}"
                       value="1"
                       class="form-control form-control-sm option-qty"
                       style="width:80px;">
                <button class="btn btn-sm btn-outline-danger">삭제</button>
            </div>
        `;

        // 수량 변경
        optionDiv.querySelector(".option-qty").addEventListener("change", e => {
            selectedOptions.get(optionId).qty = Number(e.target.value);
            updateTotalPrice();
        });

        // 옵션 삭제
        optionDiv.querySelector("button").addEventListener("click", () => {
            selectedOptions.delete(optionId);
            optionDiv.remove();
            updateTotalPrice();
        });

        selectedOptionsEl.appendChild(optionDiv);
        updateTotalPrice();
        optionSelect.value = "";
    });

    // 구매하기 버튼 눌렀을 때 실행되는 동작
    const productId = [[${product.productId}]];
    const orderBtn = document.getElementById("orderBtn");

    // 옵션 미사용 상품
    const quantityInput = document.getElementById("quantity");

    quantityInput?.addEventListener("change", ()=>{
        updateTotalPrice();
    });

    orderBtn?.addEventListener("click", ()=>{

        // 옵션 사용하는 상품
        if([[${product.useOption}]]){

            if(selectedOptions.size === 0) {
                alert("옵션을 선택해주세요.");
                return;
            }

            const params = new URLSearchParams();

            selectedOptions.forEach((value, optionId) => {
                params.append("optionIds", optionId);
                params.append("quantities", value.qty);
            });

            location.href = `/product/${productId}/order?`+params.toString();
            return;
        }

        const quantity = quantityInput.value;

        location.href = `/product/${productId}/order?quantity=${quantity}`
    });
</script>

</body>
</html>
